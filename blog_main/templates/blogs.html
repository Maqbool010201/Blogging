{% extends 'base/base.html' %}
{% load static %}
{% load ads_tags %}

{% block breadcrumbs %}
{% include 'includes/breadcrumbs.html' %}
{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'posts_by_category' post.category.id %}">
        {{ post.category.category_name }}
    </a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    {{ post.title|truncatewords:5 }}
</li>
{% endblock %}
{% endblock %}

{% block extra_head %}
<!-- SEO Meta Tags -->
<title>{{ post.meta_title|default:post.title }}</title>
<meta name="description" content="{{ post.meta_description|default:post.short_description }}">
{% if post.focus_keyword %}
<meta name="keywords" content="{{ post.focus_keyword }}">
{% endif %}
<link rel="canonical" href="{{ request.build_absolute_uri }}">

<!-- Open Graph Meta Tags -->
<meta property="og:title" content="{{ post.og_title|default:post.meta_title|default:post.title }}">
<meta property="og:description" content="{{ post.og_description|default:post.meta_description|default:post.short_description }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:type" content="article">
{% if post.og_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.og_image.url }}">
{% elif post.blog_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.blog_image.url }}">
{% endif %}

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="{{ post.twitter_card_type }}">
{% if post.twitter_site %}
<meta name="twitter:site" content="@{{ post.twitter_site }}">
{% endif %}
<meta name="twitter:title" content="{{ post.og_title|default:post.meta_title|default:post.title }}">
<meta name="twitter:description" content="{{ post.og_description|default:post.meta_description|default:post.short_description }}">
{% if post.og_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.og_image.url }}">
{% elif post.blog_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.blog_image.url }}">
{% endif %}

<!-- Schema.org Structured Data -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "{{ post.schema_type }}",
    "headline": "{{ post.meta_title|default:post.title }}",
    "description": "{{ post.meta_description|default:post.short_description }}",
    "author": {
        "@type": "Person",
        "name": "{{ post.author.get_full_name|default:post.author.username }}"
    },
    "datePublished": "{{ post.created_at|date:'c' }}",
    "dateModified": "{{ post.updated_at|date:'c' }}",
    "publisher": {
        "@type": "Organization",
        "name": "Your Blog Name",
        "logo": {
            "@type": "ImageObject",
            "url": "{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo.png' %}"
        }
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ request.build_absolute_uri }}"
    },
    {% if post.blog_image %}
    "image": {
        "@type": "ImageObject",
        "url": "{{ request.scheme }}://{{ request.get_host }}{{ post.blog_image.url }}",
        "width": "1200",
        "height": "630"
    },
    {% endif %}
    "articleBody": "{{ post.blog_body|striptags|truncatewords:100 }}",
    "wordCount": "{{ post.blog_body|striptags|wordcount }}",
    "timeRequired": "PT{{ post.estimated_reading_time }}M",
    "genre": "{{ post.category.category_name }}"
}
</script>

<meta name="robots" content="index, follow">
<meta name="author" content="{{ post.author.get_full_name|default:post.author.username }}">
{% endblock %}

{% block content %}
<!-- Post Header Section -->
<div class="post-header text-center">
    <div class="container">
        <div class="mb-3">
            <a href="{% url 'posts_by_category' post.category.id %}" class="category-badge fs-5 px-3 py-2 text-decoration-none">
                <i class="fas fa-folder me-2"></i>{{ post.category.category_name }}
            </a>
        </div>
        <h1 class="post-title">{{ post.title }}</h1>
        <div class="post-meta">
            <span><i class="fas fa-user me-1"></i>{{ post.author.get_full_name|default:post.author.username }}</span>
            <span><i class="fas fa-clock me-1"></i>{{ post.created_at|timesince }} ago</span>
            <span><i class="fas fa-eye me-1"></i>{{ post.estimated_reading_time }} min read</span>
            {% if post.focus_keyword %}
            <span><i class="fas fa-tag me-1"></i>{{ post.focus_keyword }}</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container my-5">
    <div class="row">
        <!-- Article Column -->
        <div class="col-lg-8">
            <!-- Top Ad -->
            <div class="ad-container mb-4">
                <span class="ad-label">Advertisement</span>
                <div class="ad-unit">{% show_ad 'CONTENT_TOP' post.category.id %}</div>
            </div>

            <!-- Short Description -->
            <p class="lead fst-italic text-muted mb-4">{{ post.short_description }}</p>

            <!-- Featured Image -->
            {% if post.blog_image %}
            <div class="featured-image mb-4 text-center">
                <img src="{{ post.blog_image.url }}" alt="{{ post.title }}" class="img-fluid rounded shadow">
                {% if post.blog_image.caption %}
                <small class="text-muted d-block mt-2">{{ post.blog_image.caption }}</small>
                {% endif %}
            </div>
            {% endif %}

            <!-- Blog Body -->
            <div class="blog-body mb-4">
                {{ post.blog_body|safe }}
            </div>

            <!-- Video Ad -->
            <div class="video-ad-section mb-4">
                <span class="video-ad-label">Video Advertisement</span>
                <div class="video-ad-container">{% show_ad 'CONTENT_VIDEO' post.category.id %}</div>
            </div>

            <!-- Middle Ad -->
            <div class="ad-container mb-4">
                <span class="ad-label">Sponsored Content</span>
                <div class="ad-unit">{% show_ad 'CONTENT_MIDDLE' post.category.id %}</div>
            </div>

            <!-- Social Share Buttons -->
            <div class="social-sharing mb-4">
                <button class="btn btn-outline-primary me-2" onclick="shareOnFacebook('{{ request.build_absolute_uri }}')">
                    <i class="fab fa-facebook-f me-1"></i>Share
                </button>
                <button class="btn btn-outline-info me-2" onclick="shareOnTwitter('{{ request.build_absolute_uri }}', '{{ post.title }}')">
                    <i class="fab fa-twitter me-1"></i>Tweet
                </button>
                <button class="btn btn-outline-primary me-2" onclick="shareOnLinkedIn('{{ request.build_absolute_uri }}')">
                    <i class="fab fa-linkedin-in me-1"></i>Share
                </button>
                <button class="btn btn-outline-secondary" onclick="copyPostLink()">
                    <i class="fas fa-link me-1"></i>Copy Link
                </button>
            </div>

            <!-- Bottom Ad -->
            <div class="ad-container mb-4">
                <span class="ad-label">Advertisement</span>
                <div class="ad-unit">{% show_ad 'CONTENT_BOTTOM' post.category.id %}</div>
            </div>

            <!-- Related Posts -->
            {% if related_posts %}
            <div class="related-posts-section mb-5">
                <h4 class="mb-3">Related Posts</h4>
                <div class="row">
                    {% for related in related_posts %}
                    <div class="col-md-6 mb-3">
                        <a href="{% url 'blog_detail' related.slug %}" class="text-decoration-none text-dark">
                            <div class="card h-100 shadow-sm">
                                {% if related.blog_image %}
                                <img src="{{ related.blog_image.url }}" class="card-img-top" alt="{{ related.title }}">
                                {% endif %}
                                <div class="card-body">
                                    <h5 class="card-title">{{ related.title|truncatewords:8 }}</h5>
                                    <p class="card-text text-muted">{{ related.short_description|truncatewords:15 }}</p>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Comments Section -->
            <div class="comments-section">
                <h4 class="mb-3">Comments <span class="badge bg-primary">{{ comment_count }}</span></h4>

                {% if user.is_authenticated %}
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-2">
                        <textarea class="form-control" name="comment" rows="3" placeholder="Add a comment..." maxlength="250" required></textarea>
                        <div class="text-end"><small class="char-count">0</small>/250</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </form>
                {% else %}
                <div class="alert alert-info">Please <a href="{% url 'login' %}?next={{ request.path }}">login</a> to comment.</div>
                {% endif %}

                {% if comments %}
                {% for comment in comments %}
                <div class="mb-3 p-2 border rounded">
                    <strong>{{ comment.user.get_full_name|default:comment.user.username }}</strong> 
                    <small class="text-muted">({{ comment.created_at|timesince }} ago)</small>
                    <p>{{ comment.comment }}</p>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">No comments yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Sidebar Top Ad -->
            <div class="ad-container mb-4">
                <span class="ad-label">Advertisement</span>
                <div class="ad-unit">{% show_ad 'SIDEBAR_TOP' post.category.id %}</div>
            </div>

            <!-- Categories -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white"><h5>Categories</h5></div>
                <div class="list-group list-group-flush">
                    {% for category in categories %}
                    <a href="{% url 'posts_by_category' category.id %}" class="list-group-item d-flex justify-content-between align-items-center">
                        {{ category.category_name }} <span class="badge bg-primary rounded-pill">{{ category.post_count }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>

            <!-- Sidebar Bottom Ad -->
            <div class="ad-container mb-4">
                <span class="ad-label">Advertisement</span>
                <div class="ad-unit">{% show_ad 'SIDEBAR_BOTTOM' post.category.id %}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hide video ad if empty
    const videoAdContainer = document.querySelector('.video-ad-container');
    if(videoAdContainer && videoAdContainer.innerHTML.trim() === ''){
        videoAdContainer.closest('.video-ad-section').style.display = 'none';
    }

    // Comment character counter
    const textarea = document.querySelector('textarea[name="comment"]');
    if(textarea){
        const counter = textarea.parentElement.querySelector('.char-count');
        textarea.addEventListener('input', ()=>{ counter.textContent = textarea.value.length; });
    }
});

// Social sharing functions
function shareOnFacebook(url){
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank','width=600,height=400');
}
function shareOnTwitter(url,text){
    window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank','width=600,height=400');
}
function shareOnLinkedIn(url){
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`, '_blank','width=600,height=400');
}
function copyPostLink(){
    navigator.clipboard.writeText('{{ request.build_absolute_uri }}').then(()=>{
        alert('Link copied!');
    });
}
</script>
{% endblock %}
